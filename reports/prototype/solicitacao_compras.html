<!-- Início do Formulário de Solicitação de Compras -->
<!DOCTYPE html>
<html lang="pt-BR" data-version="1.0" data-application="true">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Solicitação de Compras</title>
    <link type="text/css" rel="stylesheet" href="https://fluig.totvs.com/style-guide/css/fluig-style-guide.min.css">
    <script type="text/javascript" src="https://fluig.totvs.com/portal/resources/js/jquery/jquery.js"></script>
    <script type="text/javascript" src="https://fluig.totvs.com/portal/resources/js/jquery/jquery-ui.min.js"></script>
    <script type="text/javascript" src="https://fluig.totvs.com/webdesk/vcXMLRPC.js"></script>
    <script type="text/javascript" src="https://fluig.totvs.com/style-guide/js/fluig-style-guide.min.js" charset="utf-8"></script>
    <script type="text/javascript" src="https://fluig.totvs.com/ecm_resources/resources/assets/forms/forms.js?v=1.7.0-210308"></script>
    <script type="text/javascript" src="https://fluig.totvs.com/ecm_resources/resources/assets/forms/wdkdetail.js?v=1.7.0-210308"></script>
    <link rel="stylesheet" type="text/css" href="https://fluig.totvs.com/style-guide/css/fluig-style-guide-select.min.css">    

</head>
<body>
    <div class="fluig-style-guide">
        <form name="form" role="form" onsubmit="return false;">
            <!-- Cabeçalho do Formulário -->
            <div class="row">
                <div class="col-md-12">
                    <div class="panel panel-default panel-primary">
                        <div class="panel-body">
                            <div class="row">
                                <div class="col-md-8">
                                    <h1>Solicitação de Compras</h1>
                                    <p class="text-muted">Formulário para requisição de produtos e serviços</p>
                                </div>
                                <div class="col-md-4 text-right">
                                    <button id="btn-save-draft" class="btn btn-default" type="button" data-loading-text="<i class='fluigicon fluigicon-refresh icon-spin'></i> Salvando...">
                                        <i class="fluigicon fluigicon-save"></i> Salvar como Rascunho
                                    </button>
                                    <button id="btn-submit" class="btn btn-success" type="button" data-loading-text="<i class='fluigicon fluigicon-refresh icon-spin'></i> Enviando...">
                                        <i class="fluigicon fluigicon-send"></i> Enviar Solicitação
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>        

            <!-- Status do Processo -->
            <div class="row">
                <div class="col-md-12">
                    <div class="panel panel-default panel-primary">
                        <div class="panel-heading">
                            <h3 class="panel-title"><i class="fluigicon fluigicon-info"></i> Status da Solicitação</h3>
                        </div>
                        <div class="panel-body">
                            <div class="row">
                                <div class="col-md-3">
                                    <div class="panel panel-default status-card">
                                        <div class="panel-body">
                                            <h4 class="panel-title"><i class="fluigicon fluigicon-user"></i> Solicitante</h4>
                                            <p>Maria Silva</p>
                                            <span class="label label-success">Concluído</span>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="panel panel-warning status-card">
                                        <div class="panel-body">
                                            <h4 class="panel-title"><i class="fluigicon fluigicon-user-check"></i> Aprovador (Gestor)</h4>
                                            <p>Pendente</p>
                                            <span class="label label-warning">Pendente</span>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="panel panel-default status-card">
                                        <div class="panel-body">
                                            <h4 class="panel-title"><i class="fluigicon fluigicon-user-tie"></i> Aprovador (Diretoria)</h4>
                                            <p>Pendente</p>
                                            <span class="label label-default">Pendente</span>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="panel panel-default status-card">
                                        <div class="panel-body">
                                            <h4 class="panel-title"><i class="fluigicon fluigicon-shopping-cart"></i> Compras</h4>
                                            <p>Pendente</p>
                                            <span class="label label-default">Pendente</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="row">
                
            </div>
            <!-- Informações Gerais -->
            <div class="row">
                <div class="col-md-12">
                    <div class="panel panel-default panel-primary">
                        <div class="panel-heading">
                            <h3 class="panel-title"><i class="fluigicon fluigicon-info"></i> Informações Gerais</h3>
                        </div>
                        <div class="panel-body">
                            <div class="panel-body">
                                <div class="row">
                                    <div class="col-md-4">
                                        <div class="form-group has-feedback">
                                            <label for="request-date" class="control-label">Data da Solicitação <span class="text-danger">*</span></label>
                                            <div class="input-group">
                                                <span class="input-group-addon"><i class="fluigicon fluigicon-calendar"></i></span>
                                                <input type="text" id="request-date" class="form-control" readonly>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="form-group has-feedback">
                                            <label for="requester" class="control-label">Solicitante <span class="text-danger">*</span></label>
                                            <div class="input-group">
                                                <span class="input-group-addon"><i class="fluigicon fluigicon-user"></i></span>
                                                <input type="text" id="requester" value="Maria Silva" class="form-control" readonly>
                                            <span class="form-control-feedback"><i class="fluigicon fluigicon-ok"></i></span>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="form-group has-feedback">
                                            <label for="department" class="control-label">Departamento <span class="text-danger">*</span></label>
                                            <div class="input-group">
                                                <span class="input-group-addon"><i class="fluigicon fluigicon-company"></i></span>
                                                <select id="department" class="form-control" required>
                                                    <option value="" selected disabled>Selecione um departamento</option>
                                                    <option value="ti">Tecnologia da Informação</option>
                                                    <option value="rh">Recursos Humanos</option>
                                                    <option value="financeiro">Financeiro</option>
                                                    <option value="compras">Compras</option>
                                                    <option value="operacoes">Operações</option>
                                                </select>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="form-group has-feedback">
                                    <label for="justificativa" class="control-label">
                                        Justificativa da Compra <span class="text-danger">*</span>
                                        <i class="fluigicon fluigicon-info-circle" data-toggle="tooltip" title="Descreva a necessidade e finalidade da compra, incluindo detalhes relevantes para análise e aprovação"></i>
                                    </label>
                                    <textarea id="justificativa" class="form-control" rows="4" placeholder="Descreva a necessidade e finalidade da compra..." required></textarea>
                                    <span class="help-block">Máximo de 1000 caracteres</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Anexar Documentos -->
            <div class="row">
                <div class="col-md-12">
                    <div class="panel panel-default panel-primary">
                        <div class="panel-heading">
                            <h3 class="panel-title"><i class="fluigicon fluigicon-paperclip"></i> Anexar Documentos</h3>
                        </div>
                        <div class="panel-body">
                            <p class="text-muted">Anexe documentos complementares como orçamentos, especificações técnicas ou outros documentos relevantes.</p>
                            
                            <!-- Área de Upload do Fluig -->
                            <div class="row">
                                <div class="col-md-12">
                                    <div class="form-group has-feedback">
                                        <label class="control-label">Documentos Anexados</label>
                                        <div class="panel panel-default panel-primary">
                                            <div class="panel-body">
                                                <div class="drag-drop-area" id="file-upload-area">
                                                    <div class="text-center p-4">
                                                        <i class="fluigicon fluigicon-upload-cloud" style="font-size: 48px; color: #337ab7;"></i>
                                                        <h4>Arraste e solte arquivos aqui</h4>
                                                        <p class="text-muted">ou</p>
                                                        <button type="button" class="btn btn-default" id="browse-files">
                                                            <i class="fluigicon fluigicon-folder-open"></i> Selecione os arquivos
                                                        </button>
                                                        <p class="help-block">Formatos suportados: PDF, DOC, DOCX, XLS, XLSX, JPG, PNG (Máx. 10MB por arquivo)</p>
                                                    </div>
                                                </div>
                                                <input type="file" id="file-input" multiple class="hidden" accept=".pdf,.doc,.docx,.xls,.xlsx,.jpg,.jpeg,.png">
                                                <div id="file-list" class="mt-3">
                                                    <!-- Lista de arquivos será exibida aqui -->
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="panel panel-default panel-primary">
                        <div class="panel-body">
                            <div class="media">
                                <div class="media-left">
                                    <div class="file-icon" style="background-color: #e8f5e9; color: #2e7d32; padding: 10px; border-radius: 4px;">
                                        <i class="fluigicon fluigicon-file-excel" style="font-size: 24px;"></i>
                                    </div>
                                </div>
                                <div class="media-body" style="padding-left: 15px;">
                                    <h5 class="media-heading" style="margin-top: 5px;">Especificacoes_Tecnicas.xlsx</h5>
                                    <p class="text-muted" style="margin-bottom: 0;">1.2 MB</p>
                                </div>
                                <div class="media-right">
                                    <button type="button" class="btn btn-link text-danger" title="Remover arquivo">
                                        <i class="fluigicon fluigicon-remove"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Itens da Solicitação -->
            <div class="row">
                <div class="col-md-12">
                    <div class="panel panel-default panel-primary">
                        <div class="panel-heading">
                            <div class="row">
                                <div class="col-md-6">
                                    <h3 class="panel-title">Itens da Solicitação</h3>
                                </div>
                                <div class="col-md-6 text-right">
                                    <button id="add-item-btn" class="btn btn-primary">
                                        <i class="fluigicon fluigicon-plus"></i> Adicionar Item
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div class="panel-body">
                            <div class="table-responsive">
                                <table class="table table-striped table-bordered" id="items-table">
                                    <thead>
                                        <tr>
                                            <th>Item</th>
                                            <th>Descrição</th>
                                            <th class="text-center">Quantidade</th>
                                            <th class="text-right">Valor Unitário</th>
                                            <th class="text-right">Valor Total</th>
                                            <th class="text-center">Ações</th>
                                        </tr>
                                    </thead>
                                    <tbody id="items-tbody">
                                        <!-- Itens serão adicionados aqui dinamicamente -->
                                    </tbody>
                                    <tfoot>
                                        <tr class="active">
                                            <td colspan="3" class="text-right"><strong>Total:</strong></td>
                                            <td colspan="2" class="text-right">
                                                <span id="total-amount" class="h4">R$ 0,00</span>
                                            </td>
                                            <td></td>
                                        </tr>
                                    </tfoot>
                                </table>
                            </div>

                            <div class="form-group mt-4">
                                <label for="observacoes" class="control-label">Observações</label>
                                <textarea id="observacoes" class="form-control" rows="3" placeholder="Adicione observações sobre os itens da solicitação..."></textarea>
                                <span class="help-block">Máximo de 500 caracteres</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Modal para Adicionar/Editar Item -->
            <div class="modal fade fluig-styleguide" data-backdrop="static" id="itemModal" tabindex="-1" role="dialog" aria-labelledby="itemModalLabel">
                <div class="modal-dialog" role="document">
                    <div class="modal-content">
                        <div class="modal-header">
                            <button type="button" class="close" data-dismiss="modal" aria-label="Fechar">
                                <span aria-hidden="true">&times;</span>
                            </button>
                            <h4 class="modal-title">
                                <i class="fluigicon fluigicon-plus-circle"></i> 
                                <span id="itemModalLabel">Adicionar Item</span>
                            </h4>
                        </div>
                        <div class="modal-body">
                            <div class="form-horizontal" id="item-form">
                                <input type="hidden" id="edit-index" value="">
                                
                                <!-- Descrição do Item -->
                                <div class="form-group has-feedback">
                                    <label for="item-name" class="col-sm-3 control-label">
                                        Descrição <span class="text-danger">*</span>
                                    </label>
                                    <div class="col-sm-9">
                                        <input type="text" class="form-control" id="item-name" required>
                                        <span class="help-block">Descreva o item a ser adquirido</span>
                                    </div>
                                </div>
                                
                                <!-- Quantidade e Unidade -->
                                <div class="form-group has-feedback">
                                    <label class="col-sm-3 control-label">
                                        Quantidade / Unidade <span class="text-danger">*</span>
                                    </label>
                                    <div class="col-sm-4">
                                        <div class="input-group">
                                            <input type="number" class="form-control text-right" id="item-quantity" min="1" value="1" required>
                                            <span class="input-group-addon">
                                                <i class="fluigicon fluigicon-calculator"></i>
                                            </span>
                                        </div>
                                    </div>
                                    <div class="col-sm-5">
                                        <select class="form-control" id="item-unit" required>
                                            <option value="un">Unidade (UN)</option>
                                            <option value="pc">Peça (PC)</option>
                                            <option value="m">Metro (M)</option>
                                            <option value="kg">Quilograma (KG)</option>
                                            <option value="l">Litro (L)</option>
                                        </select>
                                    </div>
                                
                                <!-- Valor Unitário -->
                                <div class="form-group has-feedback">
                                    <label for="item-price" class="col-sm-3 control-label">
                                        Valor Unitário <span class="text-danger">*</span>
                                    </label>
                                    <div class="col-sm-4">
                                        <div class="input-group">
                                            <span class="input-group-addon">R$</span>
                                            <input type="text" class="form-control text-right money" id="item-price" placeholder="0,00" required>
                                        </div>
                                    </div>
                                    <div class="col-sm-5">
                                        <p class="form-control-static" id="item-total">Total: R$ 0,00</p>
                                    </div>
                                </div>
                                
                                <!-- Link de Referência -->
                                <div class="form-group has-feedback">
                                    <label for="item-link" class="col-sm-3 control-label">
                                        Link de Referência
                                    </label>
                                    <div class="col-sm-9">
                                        <div class="input-group">
                                            <span class="input-group-addon">
                                                <i class="fluigicon fluigicon-link"></i>
                                            </span>
                                            <input type="url" class="form-control" id="item-link" placeholder="https://exemplo.com/produto">
                                        </div>
                                        <span class="help-block">Link para o produto ou serviço</span>
                                    </div>
                                </div>
                                
                                <!-- Observações -->
                                <div class="form-group has-feedback">
                                    <label for="item-notes" class="col-sm-3 control-label">
                                        Observações
                                    </label>
                                    <div class="col-sm-9">
                                        <textarea class="form-control" id="item-notes" rows="2" placeholder="Informações adicionais sobre o item"></textarea>
                                        <span class="help-block">Máximo de 500 caracteres</span>
                                    </div>
                                </div>
                                <div class="form-group has-feedback">
                                    <label for="item-account" class="control-label">Conta Contábil</label>
                                    <select class="form-control" id="item-account">
                                        <option value="">Selecione uma conta contábil</option>
                                        <option value="acc1">1.1.01.01 - Materiais de Escritório</option>
                                        <option value="acc2">1.1.01.02 - Materiais de Limpeza</option>
                                        <option value="acc3">1.1.01.03 - Materiais de Informática</option>
                                        <option value="acc4">1.1.02.01 - Serviços de Terceiros</option>
                                        <option value="acc5">1.1.02.02 - Manutenção de Equipamentos</option>
                                    </select>
                                </div>
                                <div class="form-group has-feedback">
                                    <label for="item-notes" class="control-label">Observações</label>
                                    <textarea class="form-control" id="item-notes" rows="2"></textarea>
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-default" data-dismiss="modal">
                                <i class="fluigicon fluigicon-remove"></i> Cancelar
                            </button>
                            <button type="button" class="btn btn-primary" id="save-item" onclick="event.stopPropagation();">
                                <i class="fluigicon fluigicon-save"></i> Salvar Item
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            
        </form>
    </div>
    <script type="text/javascript">
        // Inicialização dos componentes do Fluig
        $(document).ready(function() {
            // Variáveis globais
            let items = [];
            let editIndex = -1;

            // Função para formatar moeda
            function formatCurrency(value) {
                return parseFloat(value).toLocaleString('pt-BR', {
                    style: 'currency',
                    currency: 'BRL'
                });
            }

            // Função para calcular o total
            function calculateTotal() {
                return items.reduce((total, item) => {
                    return total + (parseFloat(item.quantity) * parseFloat(item.price));
                }, 0);
            }

            // Função para atualizar a tabela de itens
            function updateItemsTable() {
                const tbody = $('#items-tbody');
                tbody.empty();
                
                items.forEach((item, index) => {
                    const total = item.quantity * item.price;
                    const row = `
                        <tr>
                            <td>${index + 1}</td>
                            <td>${item.name}</td>
                            <td class="text-center">${item.quantity} ${item.unit}</td>
                            <td class="text-right">${formatCurrency(item.price)}</td>
                            <td class="text-right">${formatCurrency(total)}</td>
                            <td class="text-center">
                                <button type="button" class="btn btn-xs btn-primary edit-item" data-index="${index}">
                                    <i class="fluigicon fluigicon-edit"></i>
                                </button>
                                <button type="button" class="btn btn-xs btn-danger remove-item" data-index="${index}">
                                    <i class="fluigicon fluigicon-remove"></i>
                                </button>
                            </td>
                        </tr>
                    `;
                    tbody.append(row);
                });

                // Atualiza o total
                $('#total-amount').text(formatCurrency(calculateTotal()));
            }

            // Função para limpar o formulário do modal
            function clearItemForm() {
                $('#item-form')[0].reset();
                $('#item-quantity').val(1);
                $('#item-unit').val('un');
                $('#item-total').text('Total: R$ 0,00');
                editIndex = -1;
            }

            // Função para preencher o formulário com os dados do item
            function fillItemForm(item) {
                $('#item-name').val(item.name);
                $('#item-quantity').val(item.quantity);
                $('#item-unit').val(item.unit);
                $('#item-price').val(item.price);
                $('#item-link').val(item.link || '');
                $('#item-notes').val(item.notes || '');
                $('#item-account').val(item.account || '');
                updateItemTotal();
            }

            // Função para atualizar o total no formulário
            function updateItemTotal() {
                const quantity = parseFloat($('#item-quantity').val()) || 0;
                const price = parseFloat($('#item-price').val().replace(/\./g, '').replace(',', '.')) || 0;
                const total = quantity * price;
                $('#item-total').text(`Total: ${formatCurrency(total)}`);
            }

            // Abre o modal para adicionar novo item
            $('#add-item-btn').click(function() {
                clearItemForm();
                $('#itemModalLabel').text('Adicionar Item');
                $('#itemModal').modal('show');
            });

            // Editar item existente
            $(document).on('click', '.edit-item', function() {
                editIndex = $(this).data('index');
                const item = items[editIndex];
                fillItemForm(item);
                $('#itemModalLabel').text('Editar Item');
                $('#itemModal').modal('show');
            });

            // Remover item
            $(document).on('click', '.remove-item', function() {
                const index = $(this).data('index');
                if (confirm('Tem certeza que deseja remover este item?')) {
                    items.splice(index, 1);
                    updateItemsTable();
                }
            });

            // Salvar item
            $('#save-item').click(function() {
                const item = {
                    name: $('#item-name').val(),
                    quantity: parseFloat($('#item-quantity').val()),
                    unit: $('#item-unit').val(),
                    price: parseFloat($('#item-price').val().replace(/\./g, '').replace(',', '.')),
                    link: $('#item-link').val(),
                    notes: $('#item-notes').val(),
                    account: $('#item-account').val()
                };

                if (!item.name || isNaN(item.quantity) || isNaN(item.price)) {
                    alert('Preencha todos os campos obrigatórios corretamente.');
                    return;
                }

                if (editIndex >= 0) {
                    // Atualiza item existente
                    items[editIndex] = item;
                } else {
                    // Adiciona novo item
                    items.push(item);
                }

                updateItemsTable();
                $('#itemModal').modal('hide');
            });

            // Atualiza o total quando os valores mudam
            $('#item-quantity, #item-price').on('input', updateItemTotal);

            // Inicializa o modal
            $('#itemModal').on('hidden.bs.modal', function () {
                clearItemForm();
            });
            // Define a data e hora atuais no campo de data da solicitação
            function updateRequestDateTime() {
                const now = new Date();
                const formattedDate = now.toLocaleString('pt-BR', {
                    day: '2-digit',
                    month: '2-digit',
                    year: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit',
                    hour12: false
                });
                $('#request-date').val(formattedDate);
            }
            
            // Atualiza a data/hora ao carregar a página
            updateRequestDateTime();
            // Inicializa tooltips
            $('[data-toggle="tooltip"]').tooltip();
            
            // Inicializa validação do formulário
            $('form').formValidation({
                framework: 'bootstrap',
                icon: {
                    valid: 'fluigicon fluigicon-ok',
                    invalid: 'fluigicon fluigicon-remove',
                    validating: 'fluigicon fluigicon-refresh'
                },
                fields: {
                    'department': {
                        validators: {
                            notEmpty: {
                                message: 'O departamento é obrigatório'
                            }
                        }
                    },
                    'justificativa': {
                        validators: {
                            notEmpty: {
                                message: 'A justificativa é obrigatória'
                            },
                            stringLength: {
                                max: 1000,
                                message: 'A justificativa deve ter no máximo 1000 caracteres'
                            }
                        }
                    }
                }
            });

            // Configura botões de loading
            $('button[data-loading-text]').on('click', function() {
                var btn = $(this);
                btn.button('loading');
                setTimeout(function() {
                    btn.button('reset');
                }, 3000);
            });

            // Inicializa a tabela vazia
            updateItemsTable();
        });
    </script>
</body>
</html>